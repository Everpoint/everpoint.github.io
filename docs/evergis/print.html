<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>EverGIS documentation</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">EverGIS</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Общая информация</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="system_requirements.html"><strong aria-hidden="true">1.1.</strong> Системные требования</a></li></ol></li><li class="chapter-item expanded "><a href="authentication_system.html"><strong aria-hidden="true">2.</strong> Система утентификации</a></li><li class="chapter-item expanded "><a href="resources.html"><strong aria-hidden="true">3.</strong> Пользовательские ресурсы</a></li><li class="chapter-item expanded "><a href="permissions/permissions.html"><strong aria-hidden="true">4.</strong> Система прав и разрешений</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="permissions/acl.html"><strong aria-hidden="true">4.1.</strong> Списки контроля доступа (ACL)</a></li><li class="chapter-item expanded "><a href="permissions/policies.html"><strong aria-hidden="true">4.2.</strong> Политики доступа</a></li></ol></li><li class="chapter-item expanded "><a href="rest_api.html"><strong aria-hidden="true">5.</strong> REST Api</a></li><li class="chapter-item expanded "><a href="tasks/scheduler.html"><strong aria-hidden="true">6.</strong> Отложенные задачи</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Буферные зоны</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Зоны доступности</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Массовое копирование (+ импорт/экспорт)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> Изображение для печати</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.5.</strong> Разбиение на тайлы</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Объединение слоёв</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.7.</strong> Булевые операции между слоями</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.8.</strong> Массовое копирование с фильтрацией</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.9.</strong> Массовое редактирование атрибутов</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.10.</strong> Объединение задач в пайплайны</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Векторные слои</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="query_language.html"><strong aria-hidden="true">7.1.</strong> Язык атрибутивных запросов</a></li><li class="chapter-item expanded "><a href="feature_layers/styles.html"><strong aria-hidden="true">7.2.</strong> Оформление слоёв</a></li><li class="chapter-item expanded "><a href="feature_layers/table_references.html"><strong aria-hidden="true">7.3.</strong> Связывание таблиц</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Для разработчиков</li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Документация к коду</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Настройка сервера</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Раработка плагинов</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">EverGIS documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>Платформа EverGIS - веб-сервер для анализа и визуализации геопространственных
данных.</p>
<p>Составные части платформы:</p>
<ul>
<li>
<p>Сервер Spatial Processing Core (SPCore) - основная часть платформы,
отвечающая за хранение и обработку гео-данных, подключение к внешним сервисам,
авторизацию и визуализацию данных. SPCore разработан на платформе .NET Core с
использованием языка C#.</p>
</li>
<li>
<p><a href="./authentication_system.html">Система аутентификации и управления
пользователями</a> - хранит информацию о
пользователях системы и предоставляет API для их аутентификации. Разработана
на языке Python на фреймворке Django.</p>
</li>
</ul>
<p>Взаимодействие клиентских приложений с платформой происходит через REST API и
веб-сокеты (для серверных сообщений, на которые подписан клиент).</p>
<p>Для запуска приложения требуется</p>
<ul>
<li>4 ГБ ОЗУ</li>
<li>БД Postgres 11 с установленным расширением PostGIS</li>
</ul>
<p>Для удобства разворачивания рекомендуется использовать Docker. Вне контейнеров
приложение может быть развернуто на ОС Linux и Windows, поддерживающих работу
.NET Core 2.1.</p>
<p>Сервер SPCore использует внешнюю систему для аутентификации пользователя. Это
позволяет на разных установках использовать различные провайдеры аутентификации
(например, Active Directory) без внесения изменений в сам сервер.</p>
<p>Стандартная система аутентификации использует модули Django для управления
пользователями и их ролями. Она также позволяет использовать сервисы OAuth 2.0,
такие как Google, Facebook, VK и другие.</p>
<p>Система аутентификации позволяет через интерфейс администрирования Django
управлять пользователями. Интерфейс администрирования доступен по адресу:</p>
<pre><code>GET /admin/
</code></pre>
<h1><a class="header" href="#Подключение-к-spcore" id="Подключение-к-spcore">Подключение к SPCore</a></h1>
<p>Для получения сессии SPCore используется метод системы аутентификации вызывается
метод </p>
<pre><code>POST /api/sp_session/
</code></pre>
<p>без дополнительных параметров. При вызове этого метода, система аутентификации
проверит, авторизован ли пользователь, и если так, создаст новую
пользовательскую сессию SPCore и вернет её в JSON ответе. Формат ответа
соответствует дата-контракту запроса SPCore <code>POST /security/authorize</code>:
<code>SessionInfoDc</code>:</p>
<pre><code>{
    &quot;token&quot;: &quot;session_token&quot;,
    &quot;owner&quot;: &quot;user_name&quot;,
    &quot;ownerRoles&quot;: [&quot;user_role1&quot;, &quot;user_role2&quot;, ...],
    &quot;lastAccess&quot;: &quot;2020-11-03 12:58:00&quot;
}
</code></pre>
<p>Сессия SPCore будет также прописана в cookie (название cookie: <code>_sb</code>).</p>
<p>Время жизни сессии SPCore задается в конфигурации сервера, и по умолчанию
составляет 15 минут с последнего клиентского запроса с данной сессией.</p>
<h1><a class="header" href="#Дополнительные-функции-системы-аутентификации" id="Дополнительные-функции-системы-аутентификации">Дополнительные функции системы аутентификации</a></h1>
<p>Кроме своей основной функции стандартная система аутентификации позволяет:</p>
<ul>
<li>управлять пользовательскими настройками (сброс пароля, подтверждение e-mail,
подключение сервисов OAuth)</li>
<li>задавать конфигурации клиента EverGIS, в том числе задавать разные
конфигурации для разных пользователей в зависимости от их ролей</li>
</ul>
<p>Система EverGIS позволяет пользователям загружать и обрабатывать собственные
данные. Работать с данными можно на разных уровнях:</p>
<ul>
<li>
<p>Чистые данные представляются в виде таблиц (источников данных). Каждая
пользовательская таблица представляется в виде таблице в базе данных, и,
соответственно, имеет строго заданную структуру. Для каждой таблицы можно
определить набор столбцов и их типы данных, а также некоторые дополнительные
атрибуты (например, можно ли редактировать столбец или является ли данный
столбец автоматическим счетчиком). В настоящий момент система не предоставляет
API для работы с данными в таблицах напрямую. Для работы с данными (а не с
настройками самой таблицы), следует пользоваться слоями, настроенный на нужную
таблицу.</p>
</li>
<li>
<p>Слои позволяют отфильтровать, оформить и отобразить исходные данных из таблиц
или других источников. В зависимости от типа слоя, слой может позволять</p>
<ul>
<li>получать изображение в виде готовой картинки на заданный экстент</li>
<li>получать изображение в виде набора тайлов</li>
<li>получать, редактировать и удалять отдельные объекты и их атрибуты</li>
</ul>
</li>
<li>
<p>Проекты (карты) позволяют группировать слои и сохранять дополнительную
информацию, которую в дальнейшем можно использовать для передачи другим
пользователям, или для удобной работы и демостраций.</p>
</li>
</ul>
<p>Все типы ресурсов позволяют настроить текстовое описание и изображение для
предпросмотра. Также все ресурсы хранят информацию о пользователе - владельце
ресурса, о дате создания и последнего изменения данного ресурса.</p>
<p>Система позволяет гибко <a href="./permissions/acl.html">настраивать права доступа на
ресурсы</a>, давая возможность
ограничить доступ к ресурсу только для просмотра определенными пользователями,
либо дать прав редактировать данные без возможности изменять настройки ресурса.</p>
<p>Ключевым понятием системы разрешений EverGIS является понятение роли
пользователя. Каждый пользователь может иметь одну или более ролей. Права на
ресурсы и политики задаются для ролей, а не для пользователей. Если пользователь
имеет несколько ролей, для которых задано определенное разрешение, для данного
пользователя будет применяться наименее строгое ограничение.</p>
<p>Роли могут иметь произвольное название и назначаться любым пользователям. Кроме
этого в системе есть системные роли:</p>
<ul>
<li>
<p><code>__public</code> - роль, которая добавлюется всем без исключения пользователям
системы, авторизованным и неавторизованным. Если, например, добавить
разрешение на чтение слоя <code>osm</code> для роли <code>__public</code>, то данный слой будет
доступен на чтение для неавторизованных пользователей, а также для всех
авторизованных пользователей системы.</p>
</li>
<li>
<p><code>__superuser</code> - роль суперпользователя. Если пользователь имеет данную роль, к
нему не применяются никакие проверки разрешений в системе. Данный пользователь
будет иметь возможность читать, изменить и удалять любые ресурсы и данные в
системе, а также выполнять некоторые действия, которые доступны только этой
пользователям с этой ролью (например, изменять политики доступов в системе).</p>
</li>
<li>
<p><code>__&lt;user_name&gt;</code> - роль пользователя. Для каждого зарегестрированного
пользователя создается его личная роль. Например, пользователю <code>vasya</code> после
регистрации будет назначено две роли: <code>__public</code> и <code>__vasya</code>. При создании
ресурсов пользователем, таким ресурсам по умалочанию назначается список
контроля доступа, состоящий из одной записи: <code>роль пользователя - ALL</code>,
означающая, что пользователь, создавший ресурс, имеет доступ к данному ресурсу
без ограничений</p>
</li>
</ul>
<h1><a class="header" href="#Система-прав-и-разрешений" id="Система-прав-и-разрешений">Система прав и разрешений</a></h1>
<p>Система прав и разрешений EverGIS состоит из двух частей:</p>
<ol>
<li>
<p><a href="permissions/./acl.html">Права на доступ к ресурсам</a>. Эти права представлюят из себя списки
контроля доступа (Access Control List, ACL) к слоям, таблицам и проектам в
системе.</p>
</li>
<li>
<p><a href="permissions/./policies.html">Набор политик для доступа</a> к выполнению
определенных действий. Например, политика может определять ограничения на
количество ресурсов, которые пользователи с заданной ролью может создавать.</p>
</li>
</ol>
<p>Списки контроля доступа позволяют ограничить доутуп к ресурсам определенным
пользователям, ролям с ограниченным набором разрешений.</p>
<p>Списки контроля доступа представялют собой набор записей вида <code>роль - разрешение</code>. При запросе на доступ к ресурсу, система:</p>
<ul>
<li>получает список ролей запрашивающего пользователя. Если запрашивающий
пользователь не авторизован, ему присвается одна системная роль <code>__public</code>.</li>
<li>получает все записи из списка контроля доступа, относящиеся к запрошенному
ресурсу и к любой из ролей пользователя</li>
<li>объединяет все записи в одно разрешение. Так, если для одной из
пользовательских ролей определено разрешение ReadWrite, а для драгой
Configure, система считает, что у пользователя есть все три разрешения на
доступ к данному ресурсу.</li>
</ul>
<p>В системе присутствует три уровня доступа к ресурсам:</p>
<ul>
<li><code>Read</code> - разрешает доступ к ресурсу на чтение, но запрещает вносить любые
изменения в ресурсе, включая изменения в конфигурации и в данных.</li>
<li><code>Write</code> - позволяет менять данные ресурса без изменения его конфигурации.
Нампример, для слоёв с векторными данными или таблиц, данное разрешение 
позволяет редактировать объекты внутри слоя или таблицы.</li>
<li><code>Configure</code> - позволяет изменять настройки ресурса, а также управлять списком
контроля доступа (ACL) для данного ресурса.</li>
</ul>
<p>Политики доступа определяют разрешения для пользователей на выполнения
определенных действий в системе.</p>
<p>Каждая политика имеет три параметра:</p>
<ul>
<li>тип политики - определяет, какого то, как эта политика применяется в системе</li>
<li>роль пользователя, для которой применяется данная политика</li>
<li>численное значение, определяющее ограничение, задаваемое данной политикой. Для
каждого типа политики это значение может означать разные вещи. Смотри описание
каждой из политик для подробного описания.</li>
</ul>
<p>Управление политиками производится через API security/policies, досутпное только
суперпользователю.</p>
<h1><a class="header" href="#createtable-createlayer-createproject" id="createtable-createlayer-createproject">CreateTable, CreateLayer, CreateProject</a></h1>
<p>Эти три политики определяют количество ресурсов, которыми может владеть
пользователь:</p>
<ul>
<li><code>CreateTable</code> - количество таблиц</li>
<li><code>CreateLayer</code> - количество слоёв</li>
<li><code>CreateProject</code> - количество проектов (карт)</li>
</ul>
<p>&quot;Владеть ресурсом&quot; означает, что значение поля <code>owner</code> ресурса совпадает с
именем пользователя.</p>
<p>Данные ограничения приверяются при попытке создать новый ресурс соответствующего
типа. Если количество ресурсов, которыми пользователь владеет, равно или больше
численного значения, заданного в политике, создание ресурса будет запрещено и
сервер вернет ответ с кодом 402.</p>
<p>Если политика задает отрицательное ограничение, считается, что разрешено
создание ресурсов соответствующего типа без ограничений.</p>
<p>Если для одного пользователя применяется несколько политик одного типа, то
применяется наименее строгое из ограничений. Например, если для пользователя
применяются политики типа <code>CreateTable</code> со значениями 20, 100, -1, то для
этого пользователя при создании таблиц будет применяться значение -1
(без ограничений).</p>
<h1><a class="header" href="#maxfeaturesinonetable" id="maxfeaturesinonetable">MaxFeaturesInOneTable</a></h1>
<p>Задает ограничение на количество строк в одной таблице с данными. Если значение
в политики отрицательное, пользователю разрешено добавлять записи в таблицы без
ограничений.</p>
<p>Данное ограничение применятся при создании объектов в слое или таблице любыми
способами: при добавлении нового объекта в слой, при импорте объектов из файла,
при копировании слоёв и таблиц и т.д.</p>
<h1><a class="header" href="#Ограничения-по-умполчанию" id="Ограничения-по-умполчанию">Ограничения по умполчанию</a></h1>
<p>Сервер позволяет задать политики по умолчанию, которые применяются для всех
пользователей. Если не переопределно в конфигурации сервера, данные ограничения
составляют:</p>
<ul>
<li><code>CreateTable</code> - 20</li>
<li><code>CreateLayer</code> - 200</li>
<li><code>CreateProject</code> - 200</li>
<li><code>MaxFeaturesInOneTable</code> - 20 000</li>
</ul>
<p>Детальное описание REST API SPCore отдается через Swagger:
<a href="https://evergis.ru/swagger/">https://evergis.ru/swagger/</a>. Основные пути:</p>
<ul>
<li><code>/tables</code> - работа с таблицами (источниками данных)</li>
<li><code>/layers</code> - работа со слоями</li>
<li><code>/projects</code> - работа с проектами</li>
<li><code>/scheduler</code> - запуск и управление отложенными задачами (расчётами)</li>
</ul>
<p>Механизм отложенного выполнения задач позволяет производить расчёты и другие
операция над большими объёмами данных, которые могут занимать длительное время.
Типичный сценарий работы с отложенными задачами выглядит так:</p>
<ol>
<li>Клиент запрашивает выполнение операции на сервере.</li>
<li>Планировщик задач добавляет задачу в очередь и возвращает идентификатор
задачи.</li>
<li>Используя полученные идентификатор задачи, клиент периодически запрашивает
статус свой задачи.</li>
<li>Когда задача выполнена, сервер вместе со статусом возвращает результат
операции и список некритических ошибок, которые произошли в процессе
выполнения задачи.</li>
</ol>
<p>Кроме того, сервер позволяет подписаться на информационное сообщение об
изменении статуса задачи.</p>
<p>При запросе статуса, задача может быть в одном из следующих состояний:</p>
<ul>
<li><code>Scheduled</code> - задача добавлена в план, но ещё не взята в работу</li>
<li><code>Planning</code> - формируется план выполнения задачи</li>
<li><code>Executing</code> - задача находится в процессе выполнения</li>
<li><code>Completed</code> - задача успешно выполнена</li>
<li><code>Failed</code> - выполнение задачи завершилось критической ошибкой, после которой
дальнейшее её выполнение невозможно</li>
<li><code>Canceled</code> - выполнение задачи было отменено клиентом</li>
<li><code>Timeout</code> - на одном из шагов выполнения задачи планировщик не смог дождаться
ответа от воркера и остановил задачу. Обычно, это означает что в коде
обработчика данной задачи присутствует ошибка.</li>
</ul>
<h1><a class="header" href="#api" id="api">API</a></h1>
<p>Описание всех методов REST API находится в swagger:
<a href="https://evergis.ru/swagger">https://evergis.ru/swagger</a>.</p>
<h2><a class="header" href="#Добавление-задачи-в-план" id="Добавление-задачи-в-план">Добавление задачи в план</a></h2>
<pre><code>POST /scheduler/tasks
</code></pre>
<p>Указанный в swagger тип задачи (после знака #) передается как параметр запроса
(в swagger они представлены в таком виде из-за ограничения swagger). Например,
для запуска построения буферных зон запрос выглядит как:</p>
<pre><code>POST /scheduler/tasks?type=buffer
</code></pre>
<p>А в теле этого запроса передается структура данных, как описано в swagger.</p>
<h2><a class="header" href="#Проверка-статуса-выполнения-задачи" id="Проверка-статуса-выполнения-задачи">Проверка статуса выполнения задачи</a></h2>
<p>Данный запрос позволяет узнать текущий статус задачи и, для некоторых задач,
узнать сколько объектов из общего количество уже обработано (полезно для
отображения прогресса клиентом)</p>
<pre><code>GET /scheduler/tasks/{id}/progress
</code></pre>
<p>Если задача успешно выполнена, ответ на это запрос будет также включает
результат её выполнения (содержимое результата зависит от типа задачи).</p>
<h2><a class="header" href="#Отмена-выполнения-задачи" id="Отмена-выполнения-задачи">Отмена выполнения задачи</a></h2>
<p>Если задача находится не в терминальном статусе (Scheduled, Planning или
Executing), ее выполнение можно отменить.</p>
<pre><code>POST /scheduler/tasks/{id}/cancel
</code></pre>
<p>Атрибутивные запросы в EverGIS используются для:</p>
<ul>
<li>
<p>написания условий для фильтрации объектов в слоях, при запросе данных, при
выборе применяемого стиля</p>
</li>
<li>
<p>для динамического расчёта значений в классификаторах</p>
</li>
<li>
<p>для расчёта значений атрибутов на основе других атрибутов в операциях
массового редактирования</p>
</li>
</ul>
<p>Запросы применяются к слоям с гео-данными и при исполнении используют системные
названия атрибутов.</p>
<p>Например, если имеется слой с атрибутами <code>str_attr</code> (текст), <code>int_attr</code>
(целочисленный), для такого слоя можно составить запросы:</p>
<ul>
<li><code>str_attr is {null}</code> - вернет значение <code>true</code> если значение атрибута у объекта
не задано</li>
<li><code>str_attr + str_attr</code> - вернет текстовое значение, в котором значение атрибута
повторяется дважды</li>
<li><code>int_attr &gt; 10 &amp;&amp; int_attr &lt; 20</code> - вернет <code>true</code> если значение атрибута
находится в пределах от 10 до 20</li>
<li><code>int_attr * 2 + 5</code> - вернет целое число - результат выполнения выражения</li>
</ul>
<h1><a class="header" href="#Типы-значений" id="Типы-значений">Типы значений</a></h1>
<h2><a class="header" href="#Целые-числа" id="Целые-числа">Целые числа</a></h2>
<p>Положительные или отрицательные целочисленные значения, умещающиеся в 64 бит:</p>
<pre><code>0
5
-100
123456789
</code></pre>
<h2><a class="header" href="#Дробные-значения" id="Дробные-значения">Дробные значения</a></h2>
<p>Положительные и отрицательные дробные значения с разделителем &quot;.&quot;. Разделение
разрядов запятой не поддерживается.</p>
<pre><code>0.0
3.1415
-20.9
</code></pre>
<h2><a class="header" href="#Текстовые-значения" id="Текстовые-значения">Текстовые значения</a></h2>
<p>Текстовые значения обрамляются одинарыми или двойными кавычками. При
необходимости ввести значение с кавычками, перед кавычкой нужно поставить знак
&quot;&quot;.</p>
<pre><code>&quot;&quot;
&quot;Строковое значение&quot;
'Также строковое значение с двойными &quot; кавычками'
&quot;Двойные кавычки \&quot; обрамленные двойными кавычками&quot;
</code></pre>
<h2><a class="header" href="#Дата-и-время" id="Дата-и-время">Дата и время</a></h2>
<p>Значения типа дата и время представляются текстовым значением, перед которым
стоит знак &quot;#&quot;. Значения записываются в формате YYYY-mm-DD HH:MM:SS.</p>
<pre><code>#&quot;2019-10-08&quot;
#'2000-01-01 00:00:01'
</code></pre>
<h2><a class="header" href="#Период-времени" id="Период-времени">Период времени</a></h2>
<p>Период времени используется в комбинации с датами и временем, и позволяет
выразить выражения типа &quot;ДАТА +/- ПЕРИОД&quot;. Значение периода задается символом
&quot;#&quot;, за которым идет целое число и указатель размерности.</p>
<pre><code>#1s (одна секунда)
#5h (пять часов)
#365d (365 дней)
</code></pre>
<p>Поддерживаемые размерности:</p>
<ul>
<li><code>ms</code> - миллисекунды</li>
<li><code>s</code> - секунды</li>
<li><code>m</code> - минуты</li>
<li><code>h</code> - часы</li>
<li><code>d</code> - дни</li>
<li><code>mth</code> - месяцы</li>
<li><code>y</code> - годы</li>
</ul>
<h2><a class="header" href="#Специальные-значения" id="Специальные-значения">Специальные значения</a></h2>
<p>Специальные значения обрамляются фигурными скобками: { }.</p>
<ul>
<li><code>{null}</code> - пустое значение атрибута</li>
<li><code>{now}</code> - дата и время в момент выполнения фильтрующего запроса</li>
<li><code>{today}</code> - дата в момент выполнения фильтрующего запроса</li>
<li><code>{this_week}</code> - полночь текущего понедельника (на момент выполнения запроса)</li>
<li><code>{this_month}</code> - полночь первого числа текущего месяца (на момент выполнения
запроса)</li>
<li><code>{this_year}</code> - полночь первого января текущего года (на момент выполнения
запроса)</li>
</ul>
<h1><a class="header" href="#Операторы" id="Операторы">Операторы</a></h1>
<h2><a class="header" href="#Операторы-сравнения" id="Операторы-сравнения">Операторы сравнения</a></h2>
<ul>
<li><code>==</code></li>
<li><code>!=</code></li>
<li><code>&gt;</code></li>
<li><code>&gt;=</code></li>
<li><code>&lt;</code></li>
<li><code>&lt;=</code></li>
</ul>
<p>Операторы сравнения возвращаются булевое значение сравнения левого и правого
значения.</p>
<pre><code>int_attr == 2
str_attr != &quot;Строковое значение&quot;
date_attr == #&quot;2020-01-01&quot;
double_attr &gt;= 1.5 &amp;&amp; double_attr &lt; 5
</code></pre>
<h2><a class="header" href="#Начинается-с-заканчивается-на-содержит" id="Начинается-с-заканчивается-на-содержит">Начинается с, заканчивается на, содержит</a></h2>
<p>Для текстовых значений операторы <code>==</code> и <code>!=</code> поддерживают специальный синтаксис:</p>
<ul>
<li><code>attr == &quot;value%&quot;</code>, <code>attr != &quot;value%&quot;</code> - значение начинается (не начинается)
с текста &quot;value&quot;</li>
<li><code>attr == &quot;%value&quot;</code>, <code>attr != &quot;%value&quot;</code> - значение заканчивается (не
заканчивается) на текст &quot;value&quot;</li>
<li><code>attr == &quot;%value%&quot;</code>, <code>attr != &quot;%value%&quot;</code> - значение содержит  (не содержит)
текст &quot;value&quot;</li>
</ul>
<h2><a class="header" href="#Арифметические-операции" id="Арифметические-операции">Арифметические операции</a></h2>
<ul>
<li><code>+</code> - сложение значений. Для строковых значений - объединение двух значений в
одну строку.</li>
<li><code>-</code> - вычитание</li>
<li><code>*</code> - умножение</li>
<li><code>/</code> - деление</li>
</ul>
<h2><a class="header" href="#Булевые-операции" id="Булевые-операции">Булевые операции</a></h2>
<ul>
<li><code>||</code> - ИЛИ</li>
<li><code>&amp;&amp;</code> - И</li>
</ul>
<p>Оформление векторных слоёв задаётся через стили (StyleDc в swagger). Настройки
стиля позволяют задать:</p>
<ul>
<li>какой символ использовать для отображения объектов</li>
<li>атрибутивный фильтр для объектов. Только к объектам, удовлетворяющим заданному
условию, будет применён данный стиль.</li>
<li>минимальный и максимальный масштабы, на которых будет применён данный стиль</li>
</ul>
<p>Стили имеют вложенную структуру, то есть каждый стиль может иметь набор дочерних
стилей, которые, в свою очередь, могут иметь свой набор дочерних стилей, и т. д.
Это позволяет, например, задать стиль, при котором на мелких масштабах объекты
отображаются с подписями, на крупных масштабах без подписи, а при максимальном
отдалении не отображаются вовсе. Или задать абсолютно разные символы для
объектов в зависимости от их атрибутов.</p>
<h1><a class="header" href="#Правила-применения-стилей" id="Правила-применения-стилей">Правила применения стилей</a></h1>
<p>Когда сервер решает, какой стиль применить к очередному объекту в слое, он
действует по следующему алгоритму:</p>
<ol>
<li>Выбирается верхнеуровневый стиль слоя.</li>
<li>Если для выбранного стиля заданы ограничения по масштабу, проверяется,
попадает ли масштаб отрисовки в эти ограничения. Если нет, данный стиль
пропускается.</li>
<li>Если для выбранного стиля задан атрибутивный фильтр, проверяется,
удовлетворяет ли текущий объект этому фильтру. Если нет, стиль пропускается.</li>
<li>Если у данного стиля есть вложенные стили, для каждого из них повторяются
пункты 2-5.</li>
<li>Если у стиля задан символ, текущий объект отображается данным символом. После
отрисовки алгоритм завершается.</li>
</ol>
<p>То есть, каждый объект в слое может быть нарисован только одним стилем. Если в
слое есть больше одного (из вложенных) стиля, все условия которого выполняются
для данного объект, использован будет только первый из них. Если ни один из
вложенных стилей не подошел для данного объекта, этот объект будет отрисован
родительским стилем.</p>
<h1><a class="header" href="#Символы" id="Символы">Символы</a></h1>
<p>Символы определяют то, как объект будет отображён на карте. Например, для
точечных объектов, есть символы, которые отображают заданную точку как:</p>
<ul>
<li>кружок заданного радиуса</li>
<li>квадрат заданного размера</li>
<li>картинку</li>
<li>картинку с маской (которую можно перекрашивать, использую параметры символа)</li>
<li>и другие</li>
</ul>
<p>Некоторые символы задают элементарное представление для объектов, а некоторые
позволяют комбинировать несколько типов отображения вместе.</p>
<p>Например, композитный символ (CompositeSymbolDc) сам не добавляет ничего к
отрисовке объекта, но позволяет рисовать объект сразу несколькими простыми
символами. С помощью него можно, например, отобразить объект с подпись (задав
его вложенными символами символ для отображения самого объекта и символ для
отображения подписи объекта).</p>
<p>Полный список символов можно найти в Swagger (типы, имеющие в названии Symbol).</p>
<h1><a class="header" href="#Параметры" id="Параметры">Параметры</a></h1>
<p>Многие символы кроме свойств, заданных примитивами (числом или цветом), имеют
свойства, определенные как параметры (ParameterDc[]). Такие параметры позволяют
классифицировать объекты по данному свойству.</p>
<p>Типы параметров:</p>
<ul>
<li>
<p><code>ScaleParameterDc[]</code> - позволяет выбирать значение свойства для символа по
заданной шкале, в зависимости от вычисленного для данного объекта значения.
С помощью такого параметра можно задать, например, что радиус кружка, которым
отображается точка города, будет увеличиваться в зависимости от населения
этого города. Или цвет здания на карте будет изменяться в зависимости от
стоимости жилья в этом здании.</p>
</li>
<li>
<p><code>ByAttributeParameterDc[]</code> - позволяет задать значение свойства для символа
для определённых значений атрибута объекта. Например, для слоя автодорог, с
помощью такого параметра можно задать, что дороги типа &quot;шоссе&quot; отображаются
линией толщиной 8 пикселов, а &quot;просёлочная дорога&quot; - 2 пиксела.</p>
</li>
<li>
<p><code>CalculatedParameterDc</code> - позволяет вычислять значение свойства для символа
напрямую через из атрибутов объектов. Например, имея в атрибутах точки
значения x и y вектора силы ветра, можно задать поворот символа (стрелки) на
карте, вычисляя его из этих атрибутов.</p>
</li>
</ul>
<h1><a class="header" href="#Описание-работы-слоев-на-основе-таблиц" id="Описание-работы-слоев-на-основе-таблиц">Описание работы слоев на основе таблиц</a></h1>
<h2><a class="header" href="#Общая-информация-о-работе-слоя" id="Общая-информация-о-работе-слоя">Общая информация о работе слоя</a></h2>
<p>Слой Postgres позволяет работать с одной или несколькими таблицами.
Обязательным условием для работы слоя является наличие совместимой с настройками слоя таблицей.
При инициализации слоя сервер читает конфигурацию колонок таблицы и связывает их с атрибутами слоя. 
Настройки атрибутов позволяют управлять настройками и ограничениями колонок таблиц. Основные настройки 
атрибутов — возможность редактирования данных, видимость атрибута, псевдоним, функция агрегации. 
Одна колонка может быть иметь разные настройки за счет создания нескольких атрибутов.</p>
<p>Слой предоставляет операции над своей конфигурацией и данными. Все операции слоя осуществляются 
с учетом прав пользователя и политик безопасности. </p>
<p>Конфигурация слоя хранит все метаданные — настройки подключения к таблицам, имена колонок, настройки атрибутов,
настройки фильтрации по атрибутам и оформление слоя.</p>
<h2><a class="header" href="#Связывание-таблиц" id="Связывание-таблиц">Связывание таблиц</a></h2>
<p>Конфигурация слоя Postgres позволяет настраивать связи для нескольких внешних таблиц за раз. Для этого необходимо
указать ссылку на внешнюю таблицу, добавить колонки для связи обеих таблиц — основной и внешней, так же создать
настройки атрибутов для колонок внешней таблицы. В атрибутах внешней таблицы обязательно должна быть указана 
связывающая колонка внешней таблицы. Имена атрибутов должны быть уникальными для всего слоя. 
При считывании конфигурации, сервер преобразует указанные атрибуты слоя в SQL-запрос, за счет этого объекты
слоя дополняются данным из связанных таблиц.</p>
<p>В зависимости от параметров можно использовать два типа связей: </p>
<ul>
<li>
<p><code>Один-ко-многим</code> — связь по умолчанию. Устанавливается если отсутствует ограничение на уникальность связывающей колонки.
К результатам этого типа связи применяется группировка. Так же с этим типом связи возможно использовать агрегацию.</p>
</li>
<li>
<p><code>Один-к-одному</code> — настраивается через создание ограничения на уникальность связывающей колонки внешней таблицы. 
Для этого типа связи не используется группировка. Исключением является тот случай, когда она используется 
вместе со связью <code>Один-ко-многим</code>.</p>
</li>
</ul>
<h1><a class="header" href="#Для-разработчиков" id="Для-разработчиков">Для разработчиков</a></h1>
<p>Конфигурация слоя позволяет объединять данные нескольких таблиц в единый результат. Связи таблиц настраиваются
через свойство <code>TableReferences</code> в конфигурации атрибутов слоя <code>AttributesConfigurationDc</code>. Слой и его таблицу 
можно связать с несколькими внешними таблицами.  Наличие колонки геометрии во внешней таблице не обязательно. 
Чтобы связать таблицы, необходимо заполнить свойства объекта <code>TableReferenceConfigurationDc</code>.</p>
<h3><a class="header" href="#Создатие-конфигурации-слоя-с-несколькими-таблицами" id="Создатие-конфигурации-слоя-с-несколькими-таблицами">Создатие конфигурации слоя с несколькими таблицами:</a></h3>
<pre><code>POST: /layers?type=PostgresLayerService
</code></pre>
<h3><a class="header" href="#Редактирование-конфигурации-слоя-с-несколькими-таблицами" id="Редактирование-конфигурации-слоя-с-несколькими-таблицами">Редактирование конфигурации слоя с несколькими таблицами:</a></h3>
<pre><code>PATCH: /layers/&lt;layer_name&gt;?type=PostgresLayerService
</code></pre>
<h2><a class="header" href="#Описание-свойств" id="Описание-свойств">Описание свойств:</a></h2>
<ul>
<li>
<p><code>TableName</code> — имя внешней таблицы, с которой связывается основная таблица слоя.</p>
</li>
<li>
<p><code>ReferenceColumn</code> и <code>TargetColumn</code> — имена колонок для связи таблиц <code>основная</code> и <code>внешняя</code>. 
Колонки должны быть одного типа данных.</p>
</li>
<li>
<p><code>Attributes</code> — список атрибутов внешней таблицы. Указываются имена колонок таблицы, данные которых будут
включены в результат соединения. Для каждой колонки необходимо задать уникальное имя атрибута. Уникальность должна
обеспечиваться среди атрибутов всех связываемых таблиц включая основную. Также в списке атрибутов внешней таблицы 
должна быть ее связывающая колонка.</p>
</li>
<li>
<p><code>TableReferences</code>— список внутренних ссылок на таблицы, дает возможность связывать внешние таблицы между собой.</p>
</li>
</ul>
<h2><a class="header" href="#Типы-связей" id="Типы-связей">Типы связей:</a></h2>
<ul>
<li>
<p><code>One-To-One</code> — связывает две таблицы отношением один-к-одному. Каждая строка основной таблицы дополняется значениями
строки внешней таблицы. Для настройки этого вида связи требуется, чтобы колонка <code>TargetColumnn</code> внешней таблицы имела
ограничение на уникальность данных. Его можно задать через свойство <code>IsUnique</code> в описании настройки колонки таблицы
<code>ColumnDescriptionDc</code>. Группировка к этому типу связи не применяется, исключение — если она не используется вместе
со связью <code>One-To-Many</code></p>
</li>
<li>
<p><code>One-To-Many</code> — связывает две таблицы отношением один-ко-многим. Каждая строка основной таблицы дополняется 
множеством строк из внешней таблицы, к результатам применяется группировка. Так же с этим типом связи
можно использовать агрегацию.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
